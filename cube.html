<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Spinning Cube with Audio</title>
    <style>
        body { 
            margin: 0;
            overflow: hidden;
        }
        canvas { 
            display: block; 
        }
        #ar-button {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 20px;
            padding: 12px 24px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            z-index: 100;
        }
        #ar-button:disabled {
            background-color: #cccccc;
            cursor: default;
        }
        #audio-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background-color: #34a853;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            z-index: 100;
        }
    </style>
</head>
<body>
    <button id="ar-button">Start AR</button>
    <button id="audio-toggle">Toggle Audio</button>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/webxr/ARButton.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/XRControllerModelFactory.js"></script>
    <script>
        // Initialize variables
        let container, scene, camera, renderer;
        let cube;
        let controller;
        let reticle;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        
        // Audio variables
        let audioListener;
        let placementSound;
        let backgroundSound;
        let audioEnabled = true;
        
        init();
        animate();
        
        function init() {
            container = document.createElement('div');
            document.body.appendChild(container);
            
            // Create scene
            scene = new THREE.Scene();
            
            // Create camera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Initialize audio
            initAudio();
            
            // Add AR button
            document.getElementById('ar-button').addEventListener('click', async () => {
                try {
                    await renderer.xr.isSessionSupported('immersive-ar').then((supported) => {
                        if (supported) {
                            const sessionInit = { 
                                optionalFeatures: ['hit-test', 'dom-overlay'],
                                domOverlay: { root: document.body }
                            };
                            renderer.xr.setReferenceSpaceType('local');
                            renderer.xr.startSession('immersive-ar', sessionInit);
                            document.getElementById('ar-button').style.display = 'none';
                            
                            // Play background music when AR starts
                            if (audioEnabled) {
                                backgroundSound.play();
                            }
                        } else {
                            alert('AR is not supported on your device');
                        }
                    });
                } catch (error) {
                    console.error('AR session failed:', error);
                }
            });
            
            // Add audio toggle button
            document.getElementById('audio-toggle').addEventListener('click', toggleAudio);
            
            // Add light
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(1, 1, 1);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040));
            
            // Create reticle (for placement indicator)
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.05, 0.1, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);
            
            // Set up controller
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Check AR support
            checkARSupport();
        }
        
        function initAudio() {
            // Create audio listener (attached to camera)
            audioListener = new THREE.AudioListener();
            camera.add(audioListener);
            
            // Create placement sound
            const placementLoader = new THREE.AudioLoader();
            placementSound = new THREE.Audio(audioListener);
            placementLoader.load('https://assets.codepen.io/21542/howler-ping.mp3', (buffer) => {
                placementSound.setBuffer(buffer);
                placementSound.setVolume(0.5);
            });
            
            // Create background sound (looping)
            const backgroundLoader = new THREE.AudioLoader();
            backgroundSound = new THREE.Audio(audioListener);
            backgroundLoader.load('https://assets.codepen.io/21542/howler-ambient.mp3', (buffer) => {
                backgroundSound.setBuffer(buffer);
                backgroundSound.setLoop(true);
                backgroundSound.setVolume(0.3);
            });
        }
        
        function toggleAudio() {
            audioEnabled = !audioEnabled;
            
            if (audioEnabled) {
                document.getElementById('audio-toggle').textContent = "Mute Audio";
                backgroundSound.play();
            } else {
                document.getElementById('audio-toggle').textContent = "Unmute Audio";
                backgroundSound.pause();
                placementSound.stop();
            }
        }
        
        function checkARSupport() {
            if (navigator.xr) {
                navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                    document.getElementById('ar-button').disabled = !supported;
                });
            } else {
                document.getElementById('ar-button').disabled = true;
                if (window.isSecureContext) {
                    alert('WebXR not available. Try a different browser or device.');
                } else {
                    alert('WebXR needs a secure context (HTTPS or localhost)');
                }
            }
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function onSelect() {
            if (reticle.visible && !cube) {
                // Create a red spinning cube
                const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
                const material = new THREE.MeshPhongMaterial({ 
                    color: 0xff0000,
                    shininess: 100
                });
                
                cube = new THREE.Mesh(geometry, material);
                cube.position.setFromMatrixPosition(reticle.matrix);
                scene.add(cube);
                
                // Play placement sound
                if (audioEnabled) {
                    placementSound.play();
                }
            }
        }
        
        function animate() {
            renderer.setAnimationLoop(function(timestamp, frame) {
                if (frame) {
                    const referenceSpace = renderer.xr.getReferenceSpace();
                    const session = renderer.xr.getSession();
                    
                    if (session && !hitTestSourceRequested) {
                        session.requestReferenceSpace('viewer').then((referenceSpace) => {
                            session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                                hitTestSource = source;
                            });
                        });
                        hitTestSourceRequested = true;
                    }
                    
                    if (hitTestSource && frame) {
                        const hitTestResults = frame.getHitTestResults(hitTestSource);
                        if (hitTestResults.length > 0) {
                            const hit = hitTestResults[0];
                            const pose = hit.getPose(referenceSpace);
                            reticle.visible = true;
                            reticle.matrix.fromArray(pose.transform.matrix);
                        } else {
                            reticle.visible = false;
                        }
                    }
                }
                
                // Rotate the cube if it exists
                if (cube) {
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;
                }
                
                renderer.render(scene, camera);
            });
        }
    </script>
</body>
</html>